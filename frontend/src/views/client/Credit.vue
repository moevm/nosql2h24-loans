<template>
  <div class="client-request">
    <h1>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã</h1>
    <div class="button-container">
      <Button text="–û—Ç–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É" @click="resetFilters" buttonType="button" />
      <Button text="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" @click="applyFilters" buttonType="button" />
    </div>
    <table class="extended-table">
      <thead>
        <tr>
          <th>
            <div class="filter-options">
              <div>
                <input type="checkbox" v-model="loan_name" value="–ú–æ–ª–æ–¥–µ–∂–Ω—ã–π –∫—Ä–µ–¥–∏—Ç" />
                <label>–ú–æ–ª–æ–¥–µ–∂–Ω—ã–π –∫—Ä–µ–¥–∏—Ç</label>
              </div>
              <div>
                <input type="checkbox" v-model="loan_name" value="–ò–ø–æ—Ç–µ–∫–∞" />
                <label>–ò–ø–æ—Ç–µ–∫–∞</label>
              </div>
              <div>
                <input type="checkbox" v-model="loan_name" value="–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏" />
                <label>–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏</label>
              </div>
              <div>
                <input type="checkbox" v-model="loan_name" value="–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç" />
                <label>–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç</label>
              </div>
              <div>
                <input type="checkbox" v-model="loan_name" value="–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ" />
                <label>–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
              </div>
              <div>
                <input type="checkbox" v-model="loan_name" value="–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞" />
                <label>–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</label>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <input type="date" v-model="filters.opening_date_from" />
              <span>‚Äî</span>
              <input type="date" v-model="filters.opening_date_to" />
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.amount_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.amount_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.interest_rate_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">%</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.interest_rate_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">%</span>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.expiration_time_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">–º–µ—Å.</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.expiration_time_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">–º–µ—Å.</span>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.monthly_payment_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.monthly_payment_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <input type="date" v-model="filters.next_payment_date_from" />
              <span>‚Äî</span>
              <input type="date" v-model="filters.next_payment_date_to" />
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.debt_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.debt_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">—Ä—É–±.</span>
              </div>
            </div>
          </th>
          <th>
            <div class="filter-options">
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.payments_overdue_from" placeholder="–æ—Ç" class="filter-input" :min="0"/>
                <span class="unit">–ø–ª–∞—Ç–µ–∂–µ–π</span>
              </div>
              <span>‚Äî</span>
              <div class="filter-input-wrapper">
                <input type="number" v-model="filters.payments_overdue_to" placeholder="–¥–æ" class="filter-input" :min="0"/>
                <span class="unit">–ø–ª–∞—Ç–µ–∂–µ–π</span>
              </div>
            </div>
          </th>
          <th></th> 
        </tr>
        <tr>
          <th @click="sortCredits('loan_name')">
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
            <SortArrow :sortDirection="sortDirection.loan_name" />
          </th>
          <th @click="sortCredits('opening_date')">
            –î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
            <SortArrow :sortDirection="sortDirection.opening_date" />
          </th>
          <th @click="sortCredits('amount')">
            –°—É–º–º–∞
            <SortArrow :sortDirection="sortDirection.amount" />
          </th>
          <th @click="sortCredits('interest_rate')">
            –°—Ç–∞–≤–∫–∞
            <SortArrow :sortDirection="sortDirection.interest_rate" />
          </th>
          <th @click="sortCredits('expiration_time')">
            –°—Ä–æ–∫
            <SortArrow :sortDirection="sortDirection.expiration_time" />
          </th>
          <th @click="sortCredits('monthly_payment')">
            –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂
            <SortArrow :sortDirection="sortDirection.monthly_payment" />
          </th>
          <th @click="sortCredits('next_payment_date')">
            –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
            <SortArrow :sortDirection="sortDirection.next_payment_date" />
          </th>
          <th @click="sortCredits('debt')">
            –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å
            <SortArrow :sortDirection="sortDirection.debt" />
          </th>
          <th @click="sortCredits('payments_overdue')">
            –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
            <SortArrow :sortDirection="sortDirection.payments_overdue" />
          </th>
          <th>
            –°—Å—ã–ª–∫–∞
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="request in requests" :key="request._id">
          <td>{{ request.loan_name }}</td>
          <td>{{ formatDate(request.opening_date) }}</td>
          <td>{{ request.amount }}</td>
          <td>{{ request.interest_rate }}</td>
          <td>{{ request.expiration_time }}</td>
          <td>{{ request.monthly_payment }}</td>
          <td>{{ formatDate(request.next_payment_date) }}</td>
          <td>{{ request.debt }}</td>
          <td>{{ request.payments_overdue }}</td>
          <td>
            <button @click="goToCreditDetail(request._id)">üîó</button>
          </td>
        </tr>
      </tbody>
    </table>
    <Notification 
      :message="notificationMessage" 
      :type="notificationType" 
      :visible="isNotificationVisible" 
      @close="closeNotification" />
  </div>
</template>
<script>
import axios from 'axios';
import Button from '../../components/Button.vue';
import Notification from '../../components/Notification.vue';
import SortArrow from '../../components/SortArrow.vue';

export default {
  name: 'ClientCredit',
  components: {
    Button,
    SortArrow,
    Notification
  },
  data() {
    return {
      requests: [],
      loan_name: [],
      filters: {
        opening_date_from: '',
        opening_date_to: '',
        amount_from: '',
        amount_to: '',
        interest_rate_from: '',
        interest_rate_to: '',
        expiration_time_from: '',
        expiration_time_to: '',
        monthly_payment_from: '',
        monthly_payment_to: '',
        next_payment_date_from: '',
        next_payment_date_to: '',
        debt_from: '',
        debt_to: '',
        payments_overdue_from: '',
        payments_overdue_to: ''
      },
      notificationMessage: '',
      notificationType: 'error',
      isNotificationVisible: false,
      sortDirection: {
        loan_name: 0,
        opening_date: 0,
        amount: 0,
        interest_rate: 0,
        expiration_time: 0,
        monthly_payment: 0,
        next_payment_date: 0,
        debt: 0,
        payments_overdue: 0
      },
      sortField: 'loan_name'
    };
  },
  created() {
    this.getCredits();
  },
  mounted() {
    document.title = "–ö—Ä–µ–¥–∏—Ç—ã";
  },
  methods: {
    async getCredits() {
      const userId = localStorage.getItem('userId');
      try {
        const response = await axios.get('http://127.0.0.1:5000/get_active_credits', {
          params: {
            client_id: userId
          }
        });
        this.requests = response.data;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞—è–≤–æ–∫:', error);
      }
    },

    resetFilters() {
      this.loan_name = [];
      this.filters = {
        opening_date_from: '',
        opening_date_to: '',
        amount_from: '',
        amount_to: '',
        interest_rate_from: '',
        interest_rate_to: '',
        expiration_time_from: '',
        expiration_time_to: '',
        monthly_payment_from: '',
        monthly_payment_to: '',
        next_payment_date_from: '',
        next_payment_date_to: '',
        debt_from: '',
        debt_to: '',
        payments_overdue_from: '',
        payments_overdue_to: ''
      };
      this.getCredits();
    },

    validateFilters() {
      if (this.filters.amount_from && this.filters.amount_to && this.filters.amount_from > this.filters.amount_to) {
        this.showNotification('–°—É–º–º–∞ "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Å—É–º–º—ã "–¥–æ"!', 'error');
        return false;
      }

      if (this.filters.interest_rate_from && this.filters.interest_rate_to && this.filters.interest_rate_from > this.filters.interest_rate_to) {
        this.showNotification('–°—Ç–∞–≤–∫–∞ "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Å—Ç–∞–≤–∫–∏ "–¥–æ"!', 'error');
        return false;
      }
      if (this.filters.interest_rate_to > 100) {
        this.showNotification('–°—Ç–∞–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 100 %!', 'error');
        return false;
      }

      if (this.filters.expiration_time_from && this.filters.expiration_time_to && this.filters.expiration_time_from > this.filters.expiration_time_to) {
        this.showNotification('–°—Ä–æ–∫ "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Å—Ä–æ–∫–∞ "–¥–æ"!', 'error');
        return false;
      }

      if (this.filters.opening_date_from && this.filters.opening_date_to && this.filters.opening_date_from > this.filters.opening_date_to) {
        this.showNotification('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è!', 'error');
        return false;
      }

      if (this.filters.monthly_payment_from && this.filters.monthly_payment_to && this.filters.monthly_payment_from > this.filters.monthly_payment_to) {
        this.showNotification('–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –ø–ª–∞—Ç–µ–∂–∞ "–¥–æ"!', 'error');
        return false;
      }

      if (this.filters.debt_from && this.filters.debt_to && this.filters.debt_from > this.filters.debt_to) {
        this.showNotification('–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ "–¥–æ"!', 'error');
        return false;
      }

      if (this.filters.payments_overdue_from && this.filters.payments_overdue_to && this.filters.payments_overdue_from > this.filters.payments_overdue_to) {
        this.showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π "–æ—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ "–¥–æ"!', 'error');
        return false;
      }

      const numericFilters = [
        'amount_from', 'amount_to', 'interest_rate_from', 'interest_rate_to',
        'expiration_time_from', 'expiration_time_to', 'monthly_payment_from',
        'monthly_payment_to', 'debt_from', 'debt_to', 'payments_overdue_from', 'payments_overdue_to'
      ];

      for (const filter of numericFilters) {
        if (this.filters[filter] && isNaN(this.filters[filter])) {
          this.showNotification(`${filter.replace('_', ' ')} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º!`, 'error');
          return false;
        }
      }

      return true;
    },

    async applyFilters() {
      if (!this.validateFilters()) return;
      const filter = {
        loan_name: this.loan_name.join('@'),
        ...this.filters
      };
      const userId = localStorage.getItem('userId');
      try {
        const response = await axios.get('http://127.0.0.1:5000/filter_active_credits', {
          params: {
            client_id: userId,
            ...filter
          }
        });
        this.requests = response.data;
        this.showNotification('–§–∏–ª—å—Ç—Ä—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!', 'success');
      } catch (error) {
        this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤!', 'error');
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
      }
    },

    closeNotification() {
      this.isNotificationVisible = false;
    },

    async fetchCredits() {
      const userId = localStorage.getItem('userId');
      try {
        const response = await axios.get('http://127.0.0.1:5000/sort_active_credits', {
          params: {
            client_id: userId,
            sort_field: this.sortField,
            sort_direction: this.sortDirection[this.sortField]
          }
        });
        this.requests = response.data;
      } catch (error) {
        this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏!', 'error');
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', error);
      }
    },

    sortCredits(field) {
      this.sortDirection[field] = this.sortDirection[field] === 1 ? -1 : 1;
      this.sortField = field;
      this.fetchCredits();
    },

    showNotification(message, type) {
      this.notificationMessage = message;
      this.notificationType = type;
      this.isNotificationVisible = true;
    },

    formatDate(date) {
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      };
      return new Date(date).toLocaleDateString('ru-RU', options);
    },
    
    goToCreditDetail(creditId) {
      localStorage.setItem('creditId', creditId);
      this.$router.push('/credit');
    }
  }
};

</script>

<style scoped>
.client-request {
  width: 100%;
  max-width: 2000px;
  margin: auto;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 10px;
  background-color: #f9f9f9;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
}

.table-container {
  overflow-x: auto;
  width: 100%;
}

table.extended-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  table-layout: auto;
}

th, td {
  border: 1px solid #ddd;
  padding: 15px;
  text-align: left;
  word-wrap: break-word;
  white-space: nowrap;
}

th {
  background-color: #f2f2f2;
  cursor: pointer;
}

th label {
  font-size: 14px;
  font-weight: bold;
}

th .filter-options {
  display: flex;
  flex-direction: column;
  margin-top: 10px;
}

th .filter-options div {
  display: flex;
  align-items: center;
}

th .filter-options input {
  margin-right: 8px;
}

th .filter-options span {
  margin: 0 5px;
}

tr:nth-child(even) {
  background-color: #f9f9f9;
}

tr:hover {
  background-color: #e0e0e0;
}

.button-container {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.button-container Button {
  margin: 0 20px;
}

.filter-options {
  display: flex;
  justify-content: flex-start;
}

.filter-input-wrapper {
  display: flex;
  align-items: center;
}

.filter-input {
  margin-right: 5px;
  width: 100px;
}

.unit {
  margin-left: 5px;
  font-size: 14px;
  white-space: nowrap;
  flex-shrink: 0;
}
</style>